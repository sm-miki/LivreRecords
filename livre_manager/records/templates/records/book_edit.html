{% extends 'records/base.html' %}

{% load static %}
{% load widget_tweaks %}

{% block title %}書籍情報の編集{% endblock %}

{% block breadcrumbs %}
{% endblock %}

{% block content %}

<h2>{% if is_new_record %}書籍情報の新規登録{% else %}書籍情報の編集{% endif %}</h2>

<form method="post" enctype="multipart/form-data" onkeydown="return event.key != 'Enter';">
	{% csrf_token %}
	{% for hidden in book_form.hidden_fields %}
		{{ hidden }}
	{% endfor %}

	<div>
		<table class="detail-table">
			<tbody>
			{% for field in book_form.visible_fields %}
			<tr>
				<th>{{ field.label }}</th>
				<td>
					{# エラーがある場合に invalid-input クラスを追加 #}
					{% if field.errors %}
						{{ field | add_class:"form-control invalid-input" }}
					{% else %}
						{{ field | add_class:"form-control" }}
					{% endif %}

					{% if field.errors %}
						<ul class="errorlist">
							{% for error in field.errors %}
								<li style="color: red;">{{ error }}</li>
							{% endfor %}
						</ul>
					{% endif %}
				</td>
			</tr>
			{% endfor %}

			</tbody>
		</table>
	</div>

	<div>
		<h3>著者</h3>
		{{ author_formset.management_form }}

		<table id="items-container" class="detail-table">
			<thead>
				<tr>
					<!-- ヘッダの追加 -->
					{% for colname in author_columns %}
					<th>{{ colname }}</th>
					{% endfor %}
					<th>操作</th>
				</tr>
			</thead>
			<tbody>
				<!-- 行の追加 -->
				{% for form in author_formset %}
				<tr class="author">
					{% for hidden in form.hidden_fields %}
						{{ hidden }}
					{% endfor %}

					{% for field in form.visible_fields %}
						<td>
							{{ field | add_class:"form-control"}}
						</td>
					{% endfor %}

					<td class="action-cell">
						<button type="button" class="move-row-button move-up-button" title="上へ移動"></button>
						<button type="button" class="move-row-button move-down-button" title="下へ移動"></button>
						<button type="button" class="delete-row-button" title="著者を削除">削除</button>
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
		<button type="button" id="add-item-row-button" class="btn btn-secondary">項目を追加</button>
	</div>

	<div class="container">
		<button id="submit-button" name="btn_submit" type="submit">登録</button>
		<button id="cancel-button" type="button" onclick="window.location.href='{{ cancel_url }}'">キャンセル</button>
	</div>

	<template id="empty-form-template">
		<tr class="author">
			{% for field in author_formset.empty_form.hidden_fields %}
				{{ field }}
			{% endfor %}

			{% for field in author_formset.empty_form.visible_fields %}
				<td>{{ field|add_class:"form-control" }}</td>
			{% endfor %}

			<td class="action-cell">
				<button type="button" class="move-row-button move-up-button" title="上へ移動"></button>
				<button type="button" class="move-row-button move-down-button" title="下へ移動"></button>
				<button type="button" class="delete-row-button" title="著者を削除">削除</button>
			</td>
		</tr>
	</template>
</form>

{% endblock %}

{% block extra_js %}
	<script type="module" src="{% static 'records/js/fuzzy-datetime/index.js' %}"></script>
	<script type="module" src="{% static 'records/js/book_form.js' %}"></script>
{% endblock %}